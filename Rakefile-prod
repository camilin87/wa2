import 'Rakefile'

task :configure_pyenv_linux do
    alias_filename = "~/.bash_aliases"
    bash_profile = File.expand_path alias_filename

    if not File.exists? bash_profile or not File.readlines(bash_profile).grep(/python=python3/).any?
        `echo alias python=python3 >> #{alias_filename}`
        puts "WARNING: close this shell before proceeding"
    end
end

task :install_prod_dependencies do
    install_prod_system_packages
    install_pypi_prod_dependencies

    Rake::Task["configure_uwsgi"].execute
end

def install_prod_system_packages
    pkg_dependencies = [
        "python-pip", "uwsgi", "nginx"
    ]
    install_system_dependencies_linux pkg_dependencies
end

def install_system_dependencies_linux(packages)
    packages.each do |pkg|
        sh "sudo apt-get install -y #{pkg}"
    end
end

def install_pypi_prod_dependencies
    prod_packages = [
        "python-forecastio", "bottle"
    ]
    sudo_install_pypi_packages prod_packages
end

task :configure_uwsgi do
    app_available_config = "/etc/uwsgi/apps-available/bottle.ini"
    app_path = File.join($basedir, "webapp/")
    temp_path = File.join($basedir, "temp_file.txt")

    File.open(temp_path, "w") do |f|
        lines = [
            "[uwsgi]",
            "socket = /run/uwsgi/app/bottle/socket",
            "chdir = #{app_path}",
            "master = true",
            "plugins = python",
            "file = app.py",
            "uid = www-data",
            "gid = www-data"
        ]
        lines.each do |l|
            f.puts l
        end
    end

    sh "sudo mv #{temp_path} #{app_available_config}"
    sh "sudo ln -s #{app_available_config} /etc/uwsgi/apps-enabled/bottle.ini"
    sh "sudo service uwsgi restart"
end
